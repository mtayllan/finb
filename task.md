# Funcionalidade de Divis√£o de Transa√ß√µes (Transaction Splits)

## Vis√£o Geral
Esta funcionalidade permitir√° que usu√°rios dividam transa√ß√µes entre si, mantendo o controle de quem deve o que para quem. O sistema continuar√° mostrando apenas a parte proporcional de cada usu√°rio nos relat√≥rios e c√°lculos de saldo.

## Modelos de Dados

### 1. Split Model
```ruby
# app/models/split.rb
class Split < ApplicationRecord
  belongs_to :source_transaction, class_name: 'Transaction'
  belongs_to :payer, class_name: 'User'           # Quem pagou originalmente
  belongs_to :owes_to, class_name: 'User'         # Quem deve
  belongs_to :owes_to_category, class_name: 'Category', optional: true

  validates :amount_owed, presence: true, numericality: { greater_than: 0 }
  validates :payer_id, :owes_to_id, presence: true
  validates :source_transaction_id, uniqueness: true
  validate :users_must_be_different
  validate :amount_cannot_exceed_transaction_value
  validate :owes_to_category_belongs_to_owes_to_user
end
```

**Atributos:**
- `source_transaction_id` (integer, not null) - Transa√ß√£o original
- `payer_id` (integer, not null) - ID do usu√°rio que pagou
- `owes_to_id` (integer, not null) - ID do usu√°rio que deve
- `amount_owed` (decimal, not null) - Valor devido
- `owes_to_category_id` (integer, optional) - Categoria escolhida pelo devedor
- `paid_at` (datetime, optional) - Data do pagamento (quando marcado como pago)
- `created_at`, `updated_at` (datetime)

### 2. User Model (extens√£o)
```ruby
# Adicionar ao app/models/user.rb
has_many :splits_as_payer, class_name: 'Split', foreign_key: 'payer_id'
has_many :splits_as_owes_to, class_name: 'Split', foreign_key: 'owes_to_id'

def all_splits
  Split.where('payer_id = ? OR owes_to_id = ?', id, id)
end
```

### 3. Transaction Model (extens√£o)
```ruby
# Adicionar ao app/models/transaction.rb
has_one :split, foreign_key: 'source_transaction_id', dependent: :destroy

# Virtual attribute para valor final ap√≥s split (apenas para relat√≥rios)
def final_value
  return value unless split&.payer_id == account.user_id
  value - split.amount_owed
end

def has_split?
  split.present?
end

def splittable?
  # Transa√ß√µes podem ser divididas se n√£o tiverem split ainda
  !has_split?
end
```

## Controllers e Rotas

### 1. Splits Controller
**Rota:** `/splits`

**Funcionalidades:**
- `index` - Dashboard principal com 3 abas
- `update` - Marcar como pago/n√£o pago e definir categoria
- `destroy` - Remover split

**Abas do Index:**
1. **From Me** (splits onde eu paguei)
2. **To Me** (splits onde eu devo)
3. **Summary** (resumo mensal por usu√°rio)

### 2. Transaction::Splits Controller (nested)
**Rota:** `/transactions/:transaction_id/splits`

**Funcionalidades:**
- `new` - Formul√°rio para criar split
- `create` - Criar novo split
- `edit` - Editar split existente
- `update` - Atualizar split

## Interface do Usu√°rio

### 1. Splits Dashboard (`/splits`)

#### Aba 1: From Me (Splits que eu paguei)
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Janeiro 2024                                                ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ [üçï] Jantar                             $50.00              ‚îÇ
‚îÇ Split: Eu $30 (60%) | Jo√£o $20 (40%)                       ‚îÇ
‚îÇ Status: [Pago ‚úì em 15/01] | [Pendente ‚è≥]                   ‚îÇ
‚îÇ A√ß√µes: [Marcar Pago/Pendente] [Editar] [Excluir]           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

#### Aba 2: To Me (Splits que eu devo)
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Janeiro 2024                                                ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Uber - Centro                           $25.00              ‚îÇ
‚îÇ Split: Maria $15 (60%) | Eu $10 (40%)                      ‚îÇ
‚îÇ Status: [Pendente ‚è≥]                                       ‚îÇ
‚îÇ Categoria: [Selecionar ‚ñº] [Transporte]                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

#### Aba 3: Summary (Resumo mensal)
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Eu ‚Üî Jo√£o - Janeiro 2024                                   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Eu gastei: $500.00                                         ‚îÇ
‚îÇ Jo√£o gastou: $200.00                                       ‚îÇ
‚îÇ Eu devo: $100.00                                           ‚îÇ
‚îÇ Jo√£o deve: $250.00                                         ‚îÇ
‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                                       ‚îÇ
‚îÇ Total: $700.00                                             ‚îÇ
‚îÇ Resultado: Jo√£o deve me $150.00                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 2. Formul√°rio de Split (`/transactions/:id/splits/new`)
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Dividir: Jantar - $50.00                                   ‚îÇ
‚îÇ Conta: Cart√£o Principal                                    ‚îÇ
‚îÇ Categoria: Alimenta√ß√£o                                     ‚îÇ
‚îÇ Data: 15/01/2024                                           ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Dividir com: [Jo√£o Silva ‚ñº]                               ‚îÇ
‚îÇ                                                            ‚îÇ
‚îÇ Jo√£o deve: [$20.00]                                       ‚îÇ
‚îÇ Eu fico com: $30.00 (calculado automaticamente)           ‚îÇ
‚îÇ                                                            ‚îÇ
‚îÇ [Dividir Igualmente: $25 cada] [Jo√£o paga 40%: $20]      ‚îÇ
‚îÇ                                                            ‚îÇ
‚îÇ [Criar Split] [Cancelar]                                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 3. Lista de Transa√ß√µes (modifica√ß√£o)
- Adicionar bot√£o "Split" ao lado de cada transa√ß√£o (apenas para transa√ß√µes que podem ser divididas)
- Mostrar indicador visual quando transa√ß√£o tem split
- Continuar exibindo valor original da transa√ß√£o (saldo da conta n√£o muda)
- Adicionar coluna ou indica√ß√£o do valor final do usu√°rio ap√≥s split nos relat√≥rios

## Impactos no Sistema

### 1. Relat√≥rios (Controllers que precisam de ajuste)
- `HomeController#calculate_expenses_from` - usar `final_value`
- `Reports::ExpensesByCategoriesController` - incluir splits categorizados
- `Reports::IncomeByCategoriesController` - incluir splits categorizados
- `ReportsController` - usar `final_value` nos gr√°ficos

### 2. C√°lculo de Saldos
- **Saldos das contas permanecem inalterados** - continuam usando `value` da transa√ß√£o original
- Splits afetam apenas os relat√≥rios de categoria, n√£o o saldo da conta
- O saldo da conta reflete o valor real movimentado, independente da divis√£o

### 3. Importa√ß√£o/Exporta√ß√£o
- `DataManagement::Export` - incluir splits no JSON
- `DataManagement::Import` - processar splits na importa√ß√£o

## Valida√ß√µes e Regras de Neg√≥cio

### 1. Valida√ß√µes de Seguran√ßa
- **Sistema familiar**: Todos os usu√°rios podem criar splits entre si
- Usu√°rio n√£o pode criar split consigo mesmo
- Valor do split n√£o pode exceder valor da transa√ß√£o
- Categoria do devedor deve pertencer ao usu√°rio devedor
- Cada transa√ß√£o pode ter apenas 1 split

### 2. Regras de Divis√£o
- **Uma transa√ß√£o = um split**: Divis√£o sempre entre 2 pessoas (pagador + devedor)
- Valor do split (`amount_owed`) representa quanto o devedor deve ao pagador
- Valor restante (`value - amount_owed`) fica com o pagador
- Qualquer tipo de transa√ß√£o pode ser dividida (conta corrente, cart√£o de cr√©dito, etc.)

### 3. Estados do Split
- **Pendente**: Split criado, aguardando confirma√ß√£o de pagamento
- **Pago**: Split marcado como pago pelo credor
- **Contestado**: Devedor contesta o split (funcionalidade futura)

## Casos de Uso Complexos Identificados

### 1. **Transa√ß√µes de Cart√£o de Cr√©dito**
- **Comportamento**: Transa√ß√µes de cart√£o podem ser divididas normalmente
- **Saldo do statement**: Continua mostrando valor integral da transa√ß√£o
- **Split**: Afeta apenas relat√≥rios de categoria, n√£o o statement do cart√£o

### 2. **Exclus√£o de Transa√ß√µes com Split**
- **Comportamento**: Ao excluir transa√ß√£o, o split tamb√©m √© exclu√≠do automaticamente (dependent: :destroy)
- **Valida√ß√£o**: Sistema deve alertar usu√°rio que o split ser√° perdido
- **Hist√≥rico**: Considerar log de splits exclu√≠dos para auditoria

### 3. **Altera√ß√£o de Valor da Transa√ß√£o**
- **Comportamento**: Se valor da transa√ß√£o for alterado, validar se split ainda √© v√°lido
- **Regra**: `amount_owed` n√£o pode ser maior que novo valor da transa√ß√£o
- **UX**: Sugerir reajuste proporcional do split ou exclus√£o

### 4. **Transfers vs Splits**
- **Diferen√ßa clara**: Transfers s√£o entre contas do mesmo usu√°rio, Splits s√£o entre usu√°rios diferentes
- **Regra**: Transfers n√£o podem ter splits
- **Saldo**: Transfers afetam saldo das contas, Splits afetam apenas relat√≥rios de categoria

### 5. **Simplifica√ß√£o do Modelo**
- **Uma transa√ß√£o = um split m√°ximo**: Elimina complexidade de m√∫ltiplos splits
- **Duas pessoas apenas**: Sempre pagador vs devedor, nunca divis√£o entre 3+ pessoas
- **Facilita UX**: Interface mais simples, c√°lculos mais diretos

## Tarefas de Implementa√ß√£o

### Fase 1: Modelos e Migrations
- [x] Criar migration para tabela `splits`
- [x] Implementar modelo `Split` com valida√ß√µes
- [x] Estender modelos `User` e `Transaction`
- [x] Adicionar m√©todo `final_value` virtual

### Fase 2: Controllers e Rotas ‚úÖ
- [x] Implementar `SplitsController`
- [x] Implementar `Transactions::SplitsController`
- [x] Configurar rotas nested
- [x] Implementar autentica√ß√£o/autoriza√ß√£o

### Fase 3: Views e JavaScript
- [ ] Dashboard de splits com 3 abas
- [ ] Formul√°rio de cria√ß√£o/edi√ß√£o
- [ ] Componentes Stimulus para c√°lculos din√¢micos
- [ ] Turbo frames para atualiza√ß√µes sem reload

### Fase 4: Ajustes nos Relat√≥rios
- [ ] Atualizar `HomeController`
- [ ] Atualizar controllers de reports
- [ ] Ajustar consultas para usar `final_value`
- [ ] Incluir splits categorizados nos relat√≥rios

### Fase 5: Import/Export
- [ ] Estender `DataManagement::Export`
- [ ] Estender `DataManagement::Import`
- [ ] Atualizar estrutura JSON
- [ ] Testes de integridade

### Fase 6: UX e Polimento
- [ ] Adicionar bot√£o "Split" na lista de transa√ß√µes
- [ ] Indicadores visuais para transa√ß√µes com splits
- [ ] Notifica√ß√µes para splits pendentes
- [ ] Testes de usabilidade

## Considera√ß√µes T√©cnicas

### 1. Performance
- Indexar tabela splits adequadamente
- Considerar cache para c√°lculos de summary
- Pagina√ß√£o para listas grandes de splits

### 2. Testes
- Focar em testes de modelo para valida√ß√µes
- Testes de integra√ß√£o para fluxo completo
- Manter cobertura m√≠nima conforme diretrizes do projeto

### 3. Compatibilidade
- Garantir que sistema funciona sem splits
- Migrations devem ser revers√≠veis
- N√£o quebrar funcionalidade existente


